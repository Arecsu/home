---
import { getCollection } from "astro:content"
import ReflectionsArticleLayout from "@layouts/ReflectionsArticle.astro"
import { REFLECTIONS_LANGUAGES, type SupportedReflectionsLang } from "@/languages.ts"
import { undefined } from "astro:schema"

export async function getStaticPaths() {
	const allreflections = await getCollection("reflections")
	const supportedLanguages = Object.keys(REFLECTIONS_LANGUAGES)

	return allreflections
		.map((entry) => {
			const [lang, slug] = entry.slug.split("/")

			if (supportedLanguages.includes(lang as SupportedReflectionsLang)) {
				const otherLang = Object.keys(REFLECTIONS_LANGUAGES).find((l) => l !== lang)
				const alternatereflections = allreflections.find((reflections) => reflections.slug === `${otherLang}/${slug}`)

				return {
					params: {
						lang,
						slug: slug,
					},
					props: {
						entry,
						hasAlternateVersion: !!alternatereflections,
					},
				}
			}
		})
		.filter(Boolean)
}

const { entry, hasAlternateVersion } = Astro.props
const { Content } = await entry.render()
const { lang, slug } = Astro.params as { lang: SupportedReflectionsLang; slug: string }

const alternateLang = Object.keys(REFLECTIONS_LANGUAGES).find((l) => l !== lang) as SupportedReflectionsLang
---

<ReflectionsArticleLayout 
   title={entry.data.title}
   hasAlternateVersion={hasAlternateVersion}
   alternateLang={alternateLang}
   alternateSlug={slug}
   alternateLabel={REFLECTIONS_LANGUAGES[alternateLang].articleSwitchLabel ?? undefined}
>
   <Content />
</ReflectionsArticleLayout>